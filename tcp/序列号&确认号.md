

##### TCP定义图解

![img](https://user-gold-cdn.xitu.io/2019/5/20/16ad518763d230b6?imageslim)



⚠️重点 <b>序列号/确认号</b>

![img](https://user-gold-cdn.xitu.io/2019/9/27/16d702629babb3f6?imageslim)



#### 序列号

TCP是面向字节流的协议，通过TCP传输的字节流的每个字节都分配了编号，**序列号(Sequence number)**指的是本报文第一个字节的序号。

在SYN报文中，序列号用于交换彼此的初始序列号，在其他报文中，序列号用于保证包的顺序。

在建立连接时，通信双方通过SYN报文交换彼此的**ISN(初始序列号)**。

![img](https://user-gold-cdn.xitu.io/2019/9/27/16d70264f4692792?imageslim)



#### 确认号

TCP使用**确认号(Acknowledgment number, ACK)**来告知对方下一个期望接收的序列号，<span style="color: #1e90ff">小于此确认号的所有字节都已经收到</span>。

注意点：

不是所有包都需要确认（ACK包不需要确认，否则陷入死循环）

收到包后可延迟确认

确认号永远是表示小于此确认号的字节都已经收到



### ⚠️生成规则

甲发送“Seq:x, Len:y”的数据给乙，乙的确认号是x+y，意味它接受到了x+y之前的所有字节（确认号可累计，比如x+z、x+y，如果y大，回复ACK为x+y意味着x+z也被成功接收）。

理论上，接收方回复的Ack号恰好就等于发送方的下一个Seq号。

重排和判断包的丢失就是通过这两个号实现的。



#### TCP Flags

TCP多种标记：

- SYN（Synchronize）：用于发起连接数据包同步双方的初始序列号
- ACK（Acknowledge）：确认数据包
- RST（Reset）：这个标记用来强制断开连接，通常是之前建立的连接已经不在了、包不合法、或者实在无能为力处理
- FIN（Finish）：通知对方我发完了所有数据，准备断开连接，后面我不会再发数据包给你了。
- PSH（Push）：告知对方这些数据包收到以后应该马上交给上层应用，不能缓存起来
- ...



#### 窗口大小

窗口大小(Window Size) * 窗口大小缩放因子

窗口缩放值在三次握手的时候指定，如果抓包没有抓到SYN包，wireshark是不知道真正的窗口缩放值是多少的。



#### 闲话💐 两军问题

https://blog.csdn.net/stone8761/article/details/51680790



<hr>

作业题：

1、如果一个 TCP 连接正在传送 5000 字节的数据，第一个字节的序号是 10001，数据被分为 5 段，每个段携带 1000 字节，请问每个段的序号是什么？

my：Seq 10001，Seq 11001，Seq 12001，Seq 13001，...



2、A B 两个主机之间建立了一个 TCP 连接，A 主机发给 B 主机两个 TCP 报文，大小分别是 500 和 300，第一个报文的序列号是 200，那么 B 主机接收两个报文后，返回的确认号是（）

my：ACK 1000 



3、客户端的使用 ISN=2000 打开一个连接，服务器端使用 ISN=3000 打开一个连接，经过 3 次握手建立连接。连接建立起来以后，假定客户端向服务器发送一段数据`Welcome the server!`（长度 20 Bytes），而服务器的回答数据`Thank you!`（长度 10 Bytes ），试画出三次握手和数据传输阶段报文段序列号、确认号的情况。

my：

客：SYN  Seq: 2000, Len: 0

服：SYN, ACK  Seq: 3000, Ack: 2001, Len: 0

客：ACK Ack: 3001, Len: 0

客：Len: 20

服：Len: 10

客：FIN

